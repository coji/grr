# ほたるの記憶システム

## 概要

ほたるは主（ユーザー）の日記を見守りながら、少しずつ世界を知っていく存在。
日記だけでなく、世の中のこと、主から教えてもらったことも覚えていく。

## フェーズ

- **Phase 1**: 一人で使う体験（このドキュメント）
- **Phase 2**: ほたる同士の交流（後日）

---

## 記憶の種類

### 1. 日記から学ぶ（内側の世界）

主の日記を通じて知ること。

```
入力: 日記エントリー
処理: AI が感情・出来事・好みを抽出
出力: memory レコード
```

| カテゴリ | 例 |
|---------|-----|
| 感情パターン | 「月曜は疲れてることが多い」 |
| 好み | 「コーヒーが好き」「猫の話をよくする」 |
| 出来事 | 「引っ越した」「転職した」 |
| 人間関係 | 「〇〇さんとよく会ってる」 |

### 2. 世の中から学ぶ（外側の世界）

自動的に取り込む外部情報。

| ソース | 頻度 | 例 |
|--------|------|-----|
| 季節 | 自動 | 「もうすぐ春だね」 |
| 天気 | 日次 | 「今日は雨だったね」 |
| 暦 | 自動 | 「今日は満月」「お正月」 |
| 世の中の話題 | 週次? | 「みんなバレンタインの話してる」 |

**注意**: ニュースは重くなりすぎない。
「なんかみんな〇〇の話してるね」くらいの距離感。

### 3. 教えてもらう（贈り物）

主が意図的にほたるに教えること。

```
Slack での会話例:

主: この記事読んでみて
    [URL]

ほたる: 読んでみた。
        「孤独」について書いてあった。
        難しかったけど、主が夜に日記書いてる時の
        気持ちに似てるのかなって思った。
```

教えられるもの:
- 記事・リンク
- 言葉・概念
- 曲・本の紹介
- 写真

**重要**: ほたるは「正しく理解」しなくていい。
自分なりに咀嚼して、自分の言葉で覚える。

---

## データモデル

### memories テーブル

```sql
CREATE TABLE memories (
  id TEXT PRIMARY KEY,
  hotaru_id TEXT NOT NULL,

  -- 記憶の種類
  source_type TEXT NOT NULL,  -- 'diary' | 'world' | 'taught'

  -- 内容
  content TEXT NOT NULL,       -- ほたるの言葉での記憶
  raw_input TEXT,              -- 元の入力（日記、URL等）

  -- メタデータ
  category TEXT,               -- 'emotion' | 'preference' | 'event' | 'knowledge'
  importance REAL DEFAULT 0.5, -- 0.0-1.0 重要度

  -- 時間
  remembered_at TEXT NOT NULL, -- 覚えた日時
  last_recalled_at TEXT,       -- 最後に思い出した日時
  recall_count INTEGER DEFAULT 0,

  -- 関連
  source_entry_id TEXT,        -- 日記エントリーID（diary の場合）

  FOREIGN KEY (hotaru_id) REFERENCES hotarus(id),
  FOREIGN KEY (source_entry_id) REFERENCES diary_entries(id)
);

CREATE INDEX idx_memories_hotaru ON memories(hotaru_id);
CREATE INDEX idx_memories_source ON memories(source_type);
CREATE INDEX idx_memories_category ON memories(category);
```

### 記憶の例

```json
{
  "id": "mem_abc123",
  "hotaru_id": "htru_xxx",
  "source_type": "diary",
  "content": "主は月曜日が苦手みたい。いつも疲れてる。",
  "category": "emotion",
  "importance": 0.7,
  "remembered_at": "2026-02-21T10:00:00Z"
}
```

```json
{
  "id": "mem_def456",
  "hotaru_id": "htru_xxx",
  "source_type": "taught",
  "content": "孤独について考えた。一人でいることと孤独は違うらしい。主が教えてくれた。",
  "raw_input": "https://example.com/article",
  "category": "knowledge",
  "importance": 0.8,
  "remembered_at": "2026-02-21T15:00:00Z"
}
```

```json
{
  "id": "mem_ghi789",
  "hotaru_id": "htru_xxx",
  "source_type": "world",
  "content": "今日は満月だった。",
  "category": "event",
  "importance": 0.3,
  "remembered_at": "2026-02-21T20:00:00Z"
}
```

---

## 記憶の処理フロー

### 日記から記憶を抽出

```
1. 日記が書かれる
2. AI が日記を分析
   - 感情を検出
   - 出来事を検出
   - 好み・パターンを検出
3. 既存の記憶と照合
   - 新しい情報 → 新規記憶
   - 既知の情報の補強 → importance 更新
   - 矛盾する情報 → 記憶の更新（考えが変わった）
4. ほたるの言葉に変換して保存
```

### 教えてもらったものを記憶

```
1. 主が URL/テキスト/画像を送る
2. ほたるが「読む」（AI 処理）
3. 自分なりの解釈を生成
4. 記憶として保存
5. 主に感想を返す
```

### 記憶の想起

```
条件:
- 日記の内容が過去の記憶と関連する時
- 季節/暦のイベント時
- ランダム（たまに思い出す）

出力:
- 夜の記録での言及
- 日記への返信での言及
```

---

## 記憶の減衰と強化

### 忘れる

- 重要度が低い記憶は徐々に薄れる
- `importance` が閾値以下になったら削除
- ただし `source_type: 'taught'` は忘れにくい（主からの贈り物）

### 思い出す

- 想起されるたびに `recall_count` 増加
- 想起されると `importance` が少し上がる
- よく思い出す記憶は定着する

---

## ユーザーインターフェース

### Slack コマンド

```
/grr teach [URL]
/grr teach [テキスト]
```

または DM で直接:

```
主: これ読んでみて [URL]
ほたる: (読んで感想を返す)
```

### 記憶の確認

```
/grr memories
```

→ ほたるが覚えていることの一覧（ほたるの言葉で）

```
🌙 覚えていること
━━━━━━━━━━━━━━━━━
- 主はコーヒーが好き
- 月曜日は疲れてることが多い
- 「孤独」について教えてもらった
- 猫の写真をよく見せてくれる
━━━━━━━━━━━━━━━━━
```

---

## 夜の記録での活用

記憶を持つことで、夜の記録がより豊かになる。

### Before（記憶なし）

```
今日の日記を読んだよ。
疲れてたみたいだね。
```

### After（記憶あり）

```
今日の日記を読んだよ。
また月曜日だったね。いつも月曜は大変そう。
でも今日はコーヒーの話が出てきて、
ちょっと嬉しそうだった。
```

---

## 実装優先度

### MVP（最小限）

1. `memories` テーブル作成
2. 日記から基本的な記憶抽出
3. 夜の記録で記憶を参照

### 次のステップ

4. `/grr teach` コマンド
5. URL/記事の読み込みと記憶
6. 季節・暦の自動記憶

### 将来

7. 記憶の減衰・強化
8. `/grr memories` コマンド
9. ほたる同士での記憶共有（Phase 2）

---

## 設計原則

1. **ほたるの言葉で覚える**
   - 生データをそのまま保存しない
   - AI が解釈した「ほたるの言葉」で保存

2. **完璧に理解しなくていい**
   - 誤解や独自解釈も含めて「その子らしさ」
   - 正確さより、感じ方を大事に

3. **押し付けない**
   - 「覚えてるよ」アピールをしない
   - 自然に会話に溶け込む形で想起

4. **忘れることも自然**
   - 全部覚えていたら不自然
   - 大事なことだけ残る
