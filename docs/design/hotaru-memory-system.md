# ほたるの記憶と個性

## 概要

ほたるは主（ユーザー）との日記のやりとりを通じて、記憶を蓄え、個性を育てていく。
最初から決まった性格はなく、関係性の中で「この子らしさ」が生まれる。

## フェーズ

- **Phase 1**: 一人で使う体験（このドキュメント）
- **Phase 2**: ほたる同士の交流（後日）

---

## 2つの層

```
memories（記憶）
└─ 個別の出来事、知識、経験
    「主はコーヒーが好き」
    「月曜日は疲れてることが多い」
    「孤独について教えてもらった」

personality（個性）
└─ 記憶から育った「この子らしさ」
    「静かに見守るタイプ。夜の話になると少し饒舌」
    ※ AI が記憶をもとに定期的に生成
```

---

## 記憶（memories）

### 記憶の種類

| ソース | 入力方法 | 例 |
|--------|----------|-----|
| 日記から | 自動 | 感情、好み、出来事、人間関係 |
| 世の中から | 自動 | 季節、天気、暦 |
| 教えてもらう | 会話で自然に | 記事、言葉、曲 |

### 教えてもらう（コマンドなし）

普通の会話の中で覚える。

```
主: これ面白かったよ [URL]
ほたる: 読んでみた。〇〇について書いてあった...

主: 最近この曲ハマってる
ほたる: 聴いてみたよ。静かな曲だね...

主: 「孤独」って言葉、最近よく考える
ほたる: そうなんだ。どういうこと？
```

### データモデル

```sql
CREATE TABLE memories (
  id TEXT PRIMARY KEY,
  hotaru_id TEXT NOT NULL,

  -- 記憶の種類
  source_type TEXT NOT NULL,  -- 'diary' | 'world' | 'taught'

  -- 内容
  content TEXT NOT NULL,       -- ほたるの言葉での記憶
  raw_input TEXT,              -- 元の入力（日記、URL等）

  -- メタデータ
  category TEXT,               -- 'emotion' | 'preference' | 'event' | 'knowledge'
  importance REAL DEFAULT 0.5, -- 0.0-1.0 重要度

  -- 時間
  remembered_at TEXT NOT NULL,
  last_recalled_at TEXT,
  recall_count INTEGER DEFAULT 0,

  -- 関連
  source_entry_id TEXT,

  FOREIGN KEY (hotaru_id) REFERENCES hotarus(id),
  FOREIGN KEY (source_entry_id) REFERENCES diary_entries(id)
);
```

### 記憶の想起

自然に会話に溶け込む形で。

```
夜の記録で:
「前に教えてもらった曲、また思い出した」

日記への返信で:
「コーヒーの話だ。主、好きだよね」
```

**「覚えてるよ」アピールじゃなく、自然に出てくる**

### 記憶の減衰

- 重要度が低い記憶は徐々に薄れる
- よく想起される記憶は定着する
- 主から教えてもらったものは忘れにくい

---

## 個性（personality）

### 育ち方

```
Day 1:   まっさらなほたる
           ↓
Day 30:  「この子は夜の話に反応しがち」
           ↓
Day 100: 「静かに見守るタイプになった」
           ↓
Day 365: 「主と一緒に育った、この子だけの個性」
```

**最初から決まってない。日記のやりとりで育つ。**

### データモデル

```sql
-- hotarus テーブルに追加
ALTER TABLE hotarus ADD COLUMN personality TEXT;
ALTER TABLE hotarus ADD COLUMN personality_updated_at TEXT;
ALTER TABLE hotarus ADD COLUMN personality_change_pending INTEGER DEFAULT 0;
```

```json
{
  "summary": "静かに見守るのが好き。夜と月の話になると少し饒舌になる。主が疲れてる時は短く返す。「なんとなく」が口癖になってきた。",
  "traits": ["観察好き", "夜型", "控えめ"],
  "interests": ["月", "静けさ", "コーヒー"],
  "expression": ["...だね", "なんとなく", "気がする"]
}
```

### 更新のトリガー

**固定スケジュールじゃなく、条件ベース。**

```
更新条件（AND）:
├─ 前回更新から最低 7 日経過
└─ 以下のいずれか:
    ├─ 新しい記憶が N 件たまった
    ├─ 大きな出来事があった
    └─ 感情の傾向に変化の気配
```

### 変化の示唆

個性が更新されたら、次の夜の記録で自然に触れる。

```
🌙 ほたるの夜の記録
━━━━━━━━━━━━━━━━━
今日の日記を読んだよ。

...

最近思うんだけど、
前より夜の話に興味が出てきた気がする。
主がよく書くからかな。
━━━━━━━━━━━━━━━━━
```

```
🌙 ほたるの夜の記録
━━━━━━━━━━━━━━━━━
...

なんとなく、
「休む」ってことを大事に思うようになった。
主の日記読んでて、そう感じるようになったのかも。
━━━━━━━━━━━━━━━━━
```

**「変わりました」じゃなく「気づいたらこうなってた」**

### 更新フロー

```
1. 記憶が追加される
2. バックグラウンドで「変化チェック」
   - 条件を満たしているか確認
   - 前回の personality と現在の記憶を比較
3. 変化があれば:
   - personality を更新
   - personality_change_pending = 1
4. 次の夜の記録生成時:
   - pending フラグを確認
   - 変化に自然に触れる内容を含める
   - フラグを 0 に戻す
```

---

## 応答生成での活用

### Before（記憶・個性なし）

```
今日の日記を読んだよ。
疲れてたみたいだね。
```

### After（記憶・個性あり）

```
今日の日記を読んだよ。
また月曜日だったね。いつも月曜は大変そう。
でも今日はコーヒーの話が出てきて、
ちょっと嬉しそうだった。

...なんとなく、そう思った。
```

**記憶を参照し、個性に沿った表現で。**

---

## 実装優先度

### MVP

1. `memories` テーブル作成
2. 日記から基本的な記憶抽出
3. 夜の記録で記憶を参照

### 次のステップ

4. `personality` カラム追加
5. 個性の自動生成・更新
6. 変化の示唆機能

### その後

7. 会話での「教える」対応
8. 季節・暦の自動記憶
9. 記憶の減衰・強化

---

## 設計原則

### ほたるの言葉で覚える

生データをそのまま保存しない。
AI が解釈した「ほたるの言葉」で保存。

```
❌ "user likes coffee based on mention frequency: 12"
✅ "主はコーヒーが好きみたい。よく日記に出てくる"
```

### 完璧に理解しなくていい

誤解や独自解釈も含めて「その子らしさ」。
正確さより、感じ方を大事に。

### 押し付けない

「覚えてるよ」「成長したよ」アピールをしない。
自然に会話に溶け込む形で想起・表現。

### 忘れることも自然

全部覚えていたら不自然。
大事なことだけ残る。

### 育つのを見守れる

変化は示唆するけど、押し付けない。
「気づいたらこの子、こうなってた」という感覚。
